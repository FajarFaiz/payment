<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exquisite Gourmet Order</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="order_form.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #c0392b;
            --bg-color: #f8f9fa;
            --text-color: #34495e;
            --input-bg: #fff;
            --input-border: #d1d5db;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1514986888952-8cd320577b68?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 60px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 540px;
            backdrop-filter: blur(10px);
        }
        h1 {
            font-family: 'Cormorant Garamond', serif;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 40px;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: 1px;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        input, select {
            padding: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: var(--input-bg);
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.1);
        }
        input[type="submit"] {
            background-color: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 18px;
            font-size: 1em;
        }
        input[type="submit"]:hover {
            background-color: #a93226;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(169, 50, 38, 0.3);
        }
        input[type="submit"]:active {
            transform: translateY(0);
        }
        .message {
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9em;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        a {
            display: block;
            text-align: center;
            color: var(--accent-color);
            text-decoration: none;
            margin-top: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        a:hover {
            color: #a93226;
        }
        #card-element {
            padding: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--input-bg);
        }
        #card-errors {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .lds-ring {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .lds-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 64px;
            height: 64px;
            margin: 8px;
            border: 8px solid #fff;
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #fff transparent transparent transparent;
        }
        .lds-ring div:nth-child(1) {
            animation-delay: -0.45s;
        }
        .lds-ring div:nth-child(2) {
            animation-delay: -0.3s;
        }
        .lds-ring div:nth-child(3) {
            animation-delay: -0.15s;
        }
        @keyframes lds-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #menu {
            display: none;
            margin-bottom: 25px;
        }
        #total {
            font-size: 1.2em;
            font-weight: 600;
            text-align: right;
            margin-bottom: 25px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exquisite Gourmet</h1>
        <div id="messages"></div>
        <form id="payment-form" method="POST">
            <label for="customer_name">Full Name</label>
            <input type="text" id="customer_name" name="customer_name" required placeholder="Enter your full name">
            
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required placeholder="Enter your email">
            
            <label for="dish_type">Dish Type</label>
            <select id="dish_type" name="dish_type" required>
                <option value="">Select a dish type</option>
                <option value="appetizer">Appetizer</option>
                <option value="main_course">Main Course</option>
                <option value="dessert">Dessert</option>
            </select>
            
            <div id="menu"></div>
            
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" min="1" required placeholder="Enter desired quantity">
            
            <div id="total">Total: $0.00</div>
            
            <label for="card-element">Credit or debit card</label>
            <div id="card-element">
                <!-- A Stripe Element will be inserted here. -->
            </div>
            
            <!-- Used to display form errors. -->
            <div id="card-errors" role="alert"></div>
            
            <input type="submit" value="Place Order and Pay">
        </form>
        <a href="{{ url_for('view_orders') }}">View Order History</a>
    </div>

    <div id="loading-overlay" style="display: none;">
        <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
    </div>

    <script>
    // Create a Stripe client.
    var stripe = Stripe('your_publishable_key');  // Replace with your actual publishable key
    var elements = stripe.elements();

    // Create an instance of the card Element.
    var card = elements.create('card');

    // Add an instance of the card Element into the `card-element` <div>.
    card.mount('#card-element');

    // Handle real-time validation errors from the card Element.
    card.on('change', function(event) {
        var displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Menu data (this would typically come from a server)
    const menuData = {
        appetizer: [
            { name: "Bruschetta", price: 8.99 },
            { name: "Calamari", price: 10.99 },
            { name: "Caprese Salad", price: 9.99 }
        ],
        main_course: [
            { name: "Filet Mignon", price: 29.99 },
            { name: "Salmon Fillet", price: 24.99 },
            { name: "Vegetarian Lasagna", price: 19.99 }
        ],
        dessert: [
            { name: "Tiramisu", price: 7.99 },
            { name: "Crème Brûlée", price: 8.99 },
            { name: "Chocolate Mousse", price: 6.99 }
        ]
    };

    // Function to update the menu based on dish type selection
    function updateMenu() {
        const dishType = document.getElementById('dish_type').value;
        const menuDiv = document.getElementById('menu');
        const dishes = menuData[dishType] || [];
        
        menuDiv.innerHTML = '';
        if (dishes.length > 0) {
            const select = document.createElement('select');
            select.id = 'dish_name';
            select.name = 'dish_name';
            select.required = true;
            select.innerHTML = '<option value="">Select a dish</option>';
            dishes.forEach(dish => {
                select.innerHTML += `<option value="${dish.name}" data-price="${dish.price}">${dish.name} - $${dish.price.toFixed(2)}</option>`;
            });
            menuDiv.appendChild(select);
            menuDiv.style.display = 'block';
            select.addEventListener('change', updateTotal);
        } else {
            menuDiv.style.display = 'none';
        }
        updateTotal();
    }

    // Function to update the total price
    function updateTotal() {
        const dishSelect = document.getElementById('dish_name');
        const quantity = document.getElementById('quantity').value;
        let total = 0;
        
        if (dishSelect && dishSelect.selectedIndex > 0) {
            const selectedOption = dishSelect.options[dishSelect.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price);
            total = price * (quantity || 1);
        }
        
        document.getElementById('total').textContent = `Total: $${total.toFixed(2)}`;
    }

    // Event listeners
    document.getElementById('dish_type').addEventListener('change', updateMenu);
    document.getElementById('quantity').addEventListener('input', updateTotal);

    // Handle form submission
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        if (!validateForm()) {
            return;
        }

        document.getElementById('loading-overlay').style.display = 'flex';

        stripe.createToken(card).then(function(result) {
            if (result.error) {
                // Inform the user if there was an error
                var errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
                document.getElementById('loading-overlay').style.display = 'none';
            } else {
                // Send the token to your server
                stripeTokenHandler(result.token);
            }
        });
    });

    // Submit the form with the token ID
    function stripeTokenHandler(token) {
        // Insert the token ID into the form so it gets submitted to the server
        var form = document.getElementById('payment-form');
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);
        form.appendChild(hiddenInput);

        // Submit the form
        fetch('/place_order', {
            method: 'POST',
            body: new FormData(form),
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-overlay').style.display = 'none';
            if (data.success) {
                showMessage('success', 'Order placed successfully!');
                form.reset();
                updateMenu();
                updateTotal();
            } else {
                showMessage('error', data.message || 'An error occurred while placing your order.');
            }
        })
        .catch(error => {
            document.getElementById('loading-overlay').style.display = 'none';
            showMessage('error', 'An error occurred. Please try again.');
            console.error('Error:', error);
        });
    }

    function validateForm() {
        var customerName = document.getElementById('customer_name').value.trim();
        var email = document.getElementById('email').value.trim();
        var dishType = document.getElementById('dish_type').value;
        var dishName = document.getElementById('dish_name') ? document.getElementById('dish_name').value : '';
        var quantity = document.getElementById('quantity').value.trim();

        if (customerName === "" || email === "" || dishType === "" || dishName === "" || quantity === "") {
            showMessage('error', "Please fill in all fields to complete your order.");
            return false;
        }

        if (!/\S+@\S+\.\S+/.test(email)) {
            showMessage('error', "Please enter a valid email address.");
            return false;
        }

        if (isNaN(quantity) || parseInt(quantity) < 1) {
            showMessage('error', "Please enter a valid quantity (minimum 1).");
            return false;
        }

        return true;
    }

    function showMessage(type, content) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type} fade-in`;
        messageDiv.textContent = content;
        messagesDiv.appendChild(messageDiv);
        
        // Remove the message after 5 seconds
        setTimeout(() => {
            messageDiv.remove();
        }, 5000);
    }

     // Initialize the form
     updateMenu();
    updateTotal();

    // Lazy load the background image
    const bg = new Image();
    bg.onload = function() {
        document.body.style.backgroundImage = `url(${this.src})`;
    }
    bg.src = 'https://images.unsplash.com/photo-1514986888952-8cd320577b68?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80';

    // Add input masking for better UX
    function maskCardNumber(input) {
        let value = input.replace(/\D/g, '');
        if (value.length > 16) value = value.slice(0, 16);
        let maskedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) maskedValue += ' ';
            maskedValue += value[i];
        }
        return maskedValue;
    }

     // Example usage of input masking (you'd typically do this for each input field)
     const cardNumberInput = document.querySelector('input[name="cardNumber"]');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            e.target.value = maskCardNumber(e.target.value);
        });
    }

    // Add smooth scrolling to all links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });


    // Add form autosave functionality
    let autosaveTimer;
    const formInputs = document.querySelectorAll('#payment-form input, #payment-form select');
    formInputs.forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => {
                localStorage.setItem('formData', JSON.stringify(Object.fromEntries(new FormData(form))));
            }, 1000);
        });
    });

    // Load autosaved form data
    window.addEventListener('load', () => {
        const savedData = JSON.parse(localStorage.getItem('formData'));
        if (savedData) {
            Object.keys(savedData).forEach(key => {
                const input = document.querySelector(`[name="${key}"]`);
                if (input) input.value = savedData[key];
            });
            updateMenu();
            updateTotal();
        }
    });

</script>
</body>
</html>
